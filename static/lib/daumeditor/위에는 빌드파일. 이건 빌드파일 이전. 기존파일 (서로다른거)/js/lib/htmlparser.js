!function(){function t(t,e){for(var n in e)t[n]=e[n];return t}function e(t){for(var e={},n=t.split(","),r=0;r<n.length;r++)e[n[r]]=!0,e[n[r].toUpperCase()]=!0;return e}var n=/<(?:(?:\/([A-Za-z][-A-Za-z0-9_:]*)[^>]*>)|(?:!--([\S\s]*?)-->)|(?:([A-Za-z][-A-Za-z0-9_:]*)((?:\s+(?:\/(?!>)|[^>\s=])+(?:\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|[^>\s]+))?)*?)\s*(\/?)>))/g,r=e("area,base,basefont,br,col,frame,hr,img,input,isindex,link,meta,param,embed"),a=(e("address,applet,blockquote,button,center,dd,del,dir,div,dl,dt,fieldset,form,frameset,hr,iframe,ins,isindex,li,map,menu,noframes,noscript,object,ol,p,pre,script,table,tbody,td,tfoot,th,thead,tr,ul"),e("a,abbr,acronym,applet,b,basefont,bdo,big,br,button,cite,code,del,dfn,em,font,i,iframe,img,input,ins,kbd,label,map,object,q,s,samp,script,select,small,span,strike,strong,sub,sup,textarea,tt,u,var"),e("colgroup,dd,dt,li,options,p,td,tfoot,th,thead,tr")),s=e("script,style,textarea"),i={isEmpty:function(t){for(var e in t)return!1;return!0},intersection:function(t,e){var n={};for(var r in t)r in e&&t[r]===e[r]&&(n[r]=t[r]);return n},difference:function(e,n){var r=t({},e);for(var a in n)delete r[a];return r},union:function(e,n){var r=t({},e);for(var a in n)r[a]=n[a];return r},isSubset:function(t,e){for(var n in e)if(e[n]!==t[n])return!1;return!0}},o=this.HTMLTree=function(){this.current=null,this.depth=0,this.maxDepth=0};o.create=function(){var t=new o;return t.openTag(1,"ROOT","",!1,!1),t},o.parseAttributes=function(t){var e,n=/\s*([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,r={};if(t)for(;e=n.exec(t);){var a=e[1].toLowerCase(),s=e[2]||e[3]||e[4]||"";"class"==a&&(a="className"),r[a]=s}return r},o.prototype.openTag=function(e,n,r,a){var s=1==e?n.toUpperCase():null,i={parent:this.current,nodeType:e,tagName:s,nodeData:n,restText:r||"",children:[],inheritingFontStyle:{},fontStyle:{},hasText:8==e||3==e&&!/^(\r|\n)*$/.test(n),valid:!0,unary:1!=e||a,hasKeyAttribute:!1};if(1==e){var u=i.parent?i.parent.inheritingFontStyle:{};"TABLE"==s&&(u={});var h=o.parseAttributes(r);(h.id||h.className)&&(i.hasKeyAttribute=!0);var p=FontCssProperty.create(s,h);i.fontStyle=p;var l=t({},u);l=t(u,p),i.inheritingFontStyle=l}this.current?this.current.children.push(i):(this.root=i,i.valid=!1),this.depth+=1,this.maxDepth=Math.max(this.depth,this.maxDepth),this.current=i},o.prototype.unaryTag=function(t,e,n){this.openTag(t,e,n,!0),this.closeTag()},o.prototype.closeTag=function(){this.depth-=1,this.current=this.current.parent},o.prototype.toString=function(){function t(r){n!=r&&(1==r.nodeType?(e.push("<"),e.push(r.nodeData),e.push(r.restText),e.push(">")):3==r.nodeType?e.push(r.nodeData):8==r.nodeType&&(e.push("<!--"),e.push(r.nodeData),e.push("-->")));for(var a=0;a<r.children.length;a++)t(r.children[a]);n==r||r.unary||(e.push("</"),e.push(r.nodeData),e.push(">"))}var e=[],n=this.root;return t(n),e.join("")},o.prototype.cleanHTML=function(){function t(n){n.valid&&(1==n.nodeType?(e.push("<"),e.push(n.nodeData),e.push(n.restText),e.push(">")):3==n.nodeType?e.push(n.nodeData):8==n.nodeType&&(e.push("<!--"),e.push(n.nodeData),e.push("-->")));for(var r=0;r<n.children.length;r++)t(n.children[r]);n.valid&&!n.unary&&(e.push("</"),e.push(n.nodeData),e.push(">"))}this.cleanedUp||(this.removeUseless(),this.cleanedUp=!0);var e=[];return t(this.root),e.join("")},o.prototype.postOrder=function(t){function e(n){for(var r=0;r<n.children.length;r++)e(n.children[r]);t(n)}e(this.root)},o.prototype.removeUseless=function(){var e=((new Date).getTime(),0);this.postOrder(function(n){switch(n.nodeType){case 1:for(var r=n.tagName,a={},s=0;s<n.children.length;s++){var o=n.children[s];a=0==s?t({},o.fontStyle):i.intersection(a,o.fontStyle),n.hasText||(n.hasText=o.hasText)}var u=i.difference(n.fontStyle,a);n.fontStyle=i.union(n.fontStyle,a),n.hasKeyAttribute||!FontCssProperty.TAGS_FOR_PRESENTATION[r]&&"SPAN"!=r||!i.isEmpty(u)&&n.hasText||(e++,n.valid=!1);break;case 3:n.fontStyle={};break;case 8:n.fontStyle={}}})},this.HTMLParser=function(t){function e(t,n,s){a[t]&&!v.empty()&&v.last().tagName==t&&i(t);var o=[];if(s=r[t]||!!s)m.unaryTag(1,t,n);else{v.push({tagName:t,rest:n,unary:s}),m.openTag(1,t,n,s);for(var u=o.length-1;u>=0;u--)e(o[u].tagName,o[u].rest,o[u].unary)}}function i(t){if(v.empty())return void(y=!1);var n,r=[],s=-1;for(n=v.length-1;n>=0;n--){var i=v[n];if(i.tagName==t){s=n;break}y=!1,a[i.tagName]||r.push(i)}if(s==-1)return void(y=!1);for(n=v.length-1;n>=s;n--)v.pop(),m.closeTag();for(n=r.length-1;n>=0;n--)e(r[n].tagName,r[n].rest,r[n].unary)}function u(t){m.unaryTag(3,t)}function h(t){m.unaryTag(3,t)}function p(t){m.unaryTag(8,t)}function l(){if(v.length>0){y=!1;for(var t=v.length-1;t>=0;t--)a[v[t].tagName],m.closeTag()}}var c,f,d,y=!0,g=0,v=[],m=o.create();for(v.empty=function(){return 0===this.length},v.last=function(){return this[this.length-1]};c=n.exec(t);){var T=c.index;if(T>g){var b=t.substring(g,T);d?d.push(b):u(b)}if(g=n.lastIndex,!(f=c[1])||(d&&s[f]&&(h(d.join("")),d=null),d))if(d)d.push(c[0]);else if(f=c[3]){if(/="/.test(f))continue;var x=!(!c[4]||"/"!=c[4].charAt(c[4].length-1));e(f,c[4],x),!d&&s[f]&&(d=[])}else(f=c[2])&&p(f);else i(f)}return u(t.substring(g)),l(),{wellFormed:y,maxDepth:m.maxDepth,cleanHTML:m.cleanHTML()}}}();