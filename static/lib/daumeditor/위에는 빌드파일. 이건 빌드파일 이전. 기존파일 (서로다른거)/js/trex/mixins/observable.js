_WIN.$stop={},_WIN.$propagate={},Trex.I.JobObservable=Trex.Faculty.create({jobObservers:{},observeJob:function(e,s){this.jobObservers[e]||(this.jobObservers[e]=[]),this.jobObservers[e].push(s)},reserveJob:function(e,s,r){r=r||500,this.jobObservers[e]||(this.jobObservers[e]=[]);var t=this;this.jobObservers[e].push(function(){var e=$A(arguments);setTimeout(function(){s.apply(t,e)},r)})},removeJob:function(e,s){if(this.jobObservers[e])if(s)for(var r=0;r<this.jobObservers[e].length;r++)this.jobObservers[e][r]===s&&this.jobObservers[e].splice(r,1);else this.jobObservers[e].length=0},fireJobs:function(e){var s=this,r=$A(arguments).slice(1);if(this.jobObservers[e])if(_WIN.DEBUG)this.jobObservers[e].each(function(e){e.apply(s,r)});else try{this.jobObservers[e].each(function(e){e.apply(s,r)})}catch(e){if(e!=$stop)throw e}}}),Trex.I.KeyObservable=Trex.Faculty.create({keyObservers:{},observeKey:function(e,s){var r=function(e){return(e.ctrlKey?"T":"F")+(e.altKey?"T":"F")+(e.shiftKey?"T":"F")+"_"+e.keyCode}(e);this.keyObservers[r]||(this.keyObservers[r]=[]),this.keyObservers[r].push(s)},fireKeys:function(e){var s=function(e){return(e.ctrlKey?"T":"F")+(e.altKey?"T":"F")+(e.shiftKey?"T":"F")+"_"+e.keyCode}(e);if(this.keyObservers[s]){var r=this,t=_FALSE,i=function(){t||($tx.stop(e),t=_TRUE)};this.keyObservers[s].each(function(s){try{s.apply(r,[e]),i()}catch(e){e===$stop?i():e!==$propagate&&console.log(e,e.stack)}})}},registerKeyEvent:function(e){try{$tx.observe(e,"keydown",this.fireKeys.bind(this),_TRUE)}catch(e){}}}),Trex.I.ElementObservable=Trex.Faculty.create({elementObservers:{},observeElement:function(e,s){if(e==_NULL)this.observeElement({tag:"*tx-final-body*"},s);else if(e.length)for(var r=0;r<e.length;r++){var t=e[r];this.observeElement(t,s)}else this.elementObservers[e.tag]||(this.elementObservers[e.tag]={}),e.klass||(e.klass="*tx-all-class*"),this.elementObservers[e.tag][e.klass]||(this.elementObservers[e.tag][e.klass]=[]),this.elementObservers[e.tag][e.klass].push(s)},fireElements:function(e){if(e){var s=e,r=$A(arguments).slice(1),t=this;try{var i;if($tom.kindOf(s,"img,hr,table,button,iframe"))i=this.collectObserverByElement(s.nodeName.toLowerCase(),s.className),i&&i.each(function(e){e.apply(t,[s].concat(r))});else for(;s&&(i=this.collectObserverByElement(s.nodeName.toLowerCase(),s.className),i&&i.each(function(e){e.apply(t,[s].concat(r))}),!$tom.isBody(s));)s=$tom.parent(s)}catch(e){if(e!=$stop)throw e}this.fireFinally()}},fireFinally:function(){var e=this,s=$A(arguments).slice(1),r=this.collectObserverByElement("*tx-final-body*");r&&r.each(function(r){r.apply(e,[_NULL].concat(s))})},collectObserverByElement:function(e,s){if(!this.elementObservers[e])return _NULL;var r=[];if(s=s||"",""!=s){var t=s.split(" ");for(var i in this.elementObservers[e])t.contains(i)&&r.push(this.elementObservers[e][i])}return this.elementObservers[e]["*tx-all-class*"]&&r.push(this.elementObservers[e]["*tx-all-class*"]),r.flatten()}}),Trex.I.MouseoverObservable=Trex.Faculty.create({mouseoverObservers:{},observeMouseover:function(e,s,r){this.mouseoverObservers[e]||(this.mouseoverObservers[e]={success:[],fail:[],flag:_FALSE}),this.mouseoverObservers[e].success.push(s),r&&this.mouseoverObservers[e].fail.push(r)},fireMouseover:function(e){if(e){var s=e,r=this;try{for(var t in this.mouseoverObservers)this.mouseoverObservers[t].flag=_FALSE;for(;s;){var i=this.collectMouseoverObserver(s);if(i.length>0){var o=this.getPositionByNode(s);i.each(function(e){e.apply(r,[s,o])})}if($tom.isBody(s))break;s=$tom.parent(s)}}catch(e){if(e!=$stop)throw e}this.runMouseoverFailHandler()}},runMouseoverFailHandler:function(){var e=[];for(var s in this.mouseoverObservers)this.mouseoverObservers[s].flag||e.push(this.mouseoverObservers[s].fail);e.flatten().each(function(e){e()})},collectMouseoverObserver:function(e){var s=[],r=e.className||"",t=e.tagName;if(t&&(t=t.toLowerCase(),this.mouseoverObservers[t]&&(s.push(this.mouseoverObservers[t].success),this.mouseoverObservers[t].flag=_TRUE)),""!=r)for(var i=r.split(" "),o=0,a=i.length;o<a;o++){var n=t+"."+i[o];this.mouseoverObservers[n]&&(s.push(this.mouseoverObservers[n].success),this.mouseoverObservers[n].flag=_TRUE)}return s.flatten()}}),Trex.I.Runnable=Trex.Faculty.create({isRunning:_FALSE,repeater:_NULL,threads:[],startThread:function(e){this.repeater?this.repeater.clear():this.repeater=new Trex.Repeater(this.runThread.bind(this)),this.repeater.start(e)},stopThread:function(){this.repeater.clear()},runThread:function(){this.isRunning||this.threads.length>0&&(this.isRunning=_TRUE,this.threads.shift()(),this.isRunning=_FALSE)},putThread:function(e,s){s?this.threads.unshift(e):this.threads.push(e)}});