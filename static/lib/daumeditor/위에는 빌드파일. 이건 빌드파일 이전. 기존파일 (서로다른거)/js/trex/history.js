Trex.I.History={},Trex.I.History.Standard={getRangeData:function(){throw Error("Unimplemented abstract method")},restoreRange:function(e){throw Error("Unimplemented abstract method")}},Trex.I.History.Webkit={getRangeData:function(){var e,t,n=this.canvas.getProcessor(),o=n.getTxSel(),r=o.getSel().rangeCount;if(r){var a=o.getSel().getRangeAt(0),s=a.cloneRange();s.selectNodeContents(this.canvas.getCurrentPanel().getDocument().body),s.setEnd(a.startContainer,a.startOffset),e=s.toString().length,t=e+a.toString().length}else e=0,t=0;return{start:e,end:t}},restoreRange:function(e){var t=this.canvas.getCurrentPanel().getWindow(),n=t.document,o=n.body,r=0,a=n.createRange();a.setStart(o,0),a.collapse(!0);for(var s,i=[o],d=!1,c=!1;!c&&(s=i.pop());)if(3==s.nodeType){var u=r+s.length;!d&&e.start>=r&&e.start<=u&&(a.setStart(s,e.start-r),d=!0),d&&e.end>=r&&e.end<=u&&(a.setEnd(s,e.end-r),c=!0),r=u}else for(var l=s.childNodes.length;l--;)i.push(s.childNodes[l]);var h=t.getSelection();h.removeAllRanges(),h.addRange(a)}},Trex.I.History.Trident={getRangeData:function(){var e=this.canvas.getCurrentPanel().getDocument(),t=e.body;try{var n=e.selection.createRange()}catch(e){return{start:0,end:0}}var o=e.body.createTextRange();o.moveToElementText(t);try{o.setEndPoint("EndToStart",n);var r=o.text.length;return{start:r,end:r+n.text.length}}catch(e){}var a=o.text.length;return{start:a,end:a}},restoreRange:function(e){var t=this.canvas.getCurrentPanel().getDocument(),n=t.body,o=t.body.createTextRange();o.moveToElementText(n),o.collapse(!0),o.moveEnd("character",e.end),o.moveStart("character",e.start),o.select()}},function(){function e(e,t){for(;e.length>=t;)e.shift()}var t=20;Trex.History=Trex.Class.create({$mixins:[Trex.I.History.Standard,$tx.msie_nonstd?Trex.I.History.Trident:Trex.I.History.Webkit],maxUndoCount:t,canvas:_NULL,undoMementoList:_NULL,redoMementoList:_NULL,currentMemento:_NULL,contentModified:_FALSE,initialize:function(e){this.canvas=e,this.setupHistory(),this.bindKeyEvent(e)},bindKeyEvent:function(e){var t=this;e.observeJob("canvas.panel.undo",function(){t.undoHandler()}),e.observeJob("canvas.panel.redo",function(){t.redoHandler()})},setupHistory:function(){this.initHistory({content:$tom.EMPTY_PARAGRAPH_HTML,scrollTop:0})},canUndo:function(){return this.undoMementoList.length>0},canRedo:function(){return this.redoMementoList.length>0},setCurrentMemento:function(e){this.currentMemento=e},undoHandler:function(){var e=this;if(e.saveHistoryIfEdited(),e.canUndo()){var t=e.undoMementoList.pop();t.undo(),e.redoMementoList.push(t),e.setCurrentMemento(t)}},redoHandler:function(){var e=this;if(e.saveHistoryIfEdited(),e.canRedo()){var t=e.redoMementoList.pop();t.redo(),e.undoMementoList.push(t),e.setCurrentMemento(t)}},initHistory:function(e){var t=this;t.undoMementoList=[],t.redoMementoList=[];var o=new n,r=Object.extend({content:$tom.EMPTY_PARAGRAPH_HTML,scrollTop:0},e);o.addUndoData(r),o.addHandler(t.getTextHandler()),t.setCurrentMemento(o)},saveHistory:function(t,o,r){var a=this,s=a.undoMementoList,i=a.currentMemento;a.redoMementoList=[],3==arguments.length&&i.addUndoRedData(t,o,r);var d=a.getTextData();i.addRedoData(d),e(s,a.maxUndoCount),s.push(i);var c=new n;c.addHandler(a.getTextHandler()),c.addUndoData(d),a.setCurrentMemento(c),a.contentModified=_FALSE},injectHistory:function(e,t,n){if(this.canUndo()){var o=this.undoMementoList,r=o[o.length-1];r.addUndoRedData(e,t,n)}},saveHistoryIfEdited:function(){this.contentModified&&this.saveHistory()},saveHistoryByKeyEvent:function(e){var t={code:e.keyCode,ctrl:e.ctrlKey||17===e.keyCode,alt:e.altKey||18===e.keyCode,shift:e.shiftKey||16===e.keyCode};if(229!=t.code){var n=this;t.code==Trex.__KEY.ENTER||t.code==Trex.__KEY.SPACE||t.code==Trex.__KEY.TAB?n.saveHistoryIfEdited():t.code==Trex.__KEY.DELETE||t.code==Trex.__KEY.BACKSPACE?n.saveHistory():t.code!=Trex.__KEY.PASTE&&t.code!=Trex.__KEY.CUT||!t.ctrl?t.code>32&&t.code<41&&t.shift||65==t.code&&t.ctrl?n.saveHistoryIfEdited():t.ctrl||t.alt||t.shift&&16==t.code||(n.contentModified=_TRUE):n.saveHistory()}},getTextHandler:function(){var e=this.canvas,t=this;return function(n){e.setContent(n.content);var o={start:0,end:0},r=n.range||o;t.restoreRange(r),$tx.msie_nonstd&&setTimeout(function(){e.setScrollTop(n.scrollTop)},0)}},getTextData:function(){return{content:this.canvas.getContent(),scrollTop:this.canvas.getScrollTop(),range:this.getRangeData()}}});var n=Trex.Class.create({initialize:function(){this.before={},this.after={},this.handlers=[]},addUndoRedData:function(e,t,n){Object.extend(this.before,e),Object.extend(this.after,t),this.handlers.push(n)},addHandler:function(e){this.handlers.push(e)},addUndoData:function(e){Object.extend(this.before,e)},addRedoData:function(e){Object.extend(this.after,e)},undo:function(){var e=this;e.handlers.each(function(t){t(e.before)})},redo:function(){var e=this;e.handlers.each(function(t){t(e.after)})}})}();