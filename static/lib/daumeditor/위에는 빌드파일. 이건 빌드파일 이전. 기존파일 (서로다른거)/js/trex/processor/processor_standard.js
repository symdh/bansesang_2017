Trex.I.Processor={},Trex.I.Processor.Standard={txSelection:_NULL,isRangeInsideWysiwyg:_FALSE,lastRange:_NULL,initialize:function(t,e){this.win=t,this.doc=e,this.txSelection=new Trex.Canvas.Selection(this),this.bookmark=new Trex.Canvas.Bookmark(this)},getTxSel:function(){return this.txSelection},getSel:function(){return this.txSelection.getSel()},getRange:function(){return this.txSelection.getRange()},getBookmark:function(){return this.bookmark},isCollapsed:function(){return this.txSelection.isCollapsed()},getNode:function(){return this.txSelection.getNode()},getControl:function(){return this.txSelection.getControl()},hasControl:function(){return this.txSelection.hasControl()},selectControl:function(t){return this.txSelection.selectControl(t)},getText:function(){return this.txSelection.getText()},compareTextPos:function(){return this.txSelection.compareTextPos()},findNode:function(t){try{return $tom.find(this.getNode(),t)}catch(t){return _NULL}},queryStyle:function(t,e){if(!t)return _NULL;if(e="float"==e?t.style.styleFloat===_UNDEFINED?"cssFloat":"styleFloat":e,t.style&&t.style[e])return t.style[e];if(t.currentStyle&&t.currentStyle[e])return t.currentStyle[e];if(_WIN.getComputedStyle){for(var o=t;$tom.isText(o);)o=o.parentNode;var n=$tom.getWindow(this.doc),r=n.getComputedStyle(o,_NULL);return r?r[e]:_NULL}return _NULL},queryAttr:function(t,e){return t?$tom.getAttribute(t,e):_NULL},queryCommandState:function(t){try{return this.doc.queryCommandState(t)}catch(t){return _FALSE}},queryCommandValue:function(t){try{return this.doc.queryCommandValue(t)}catch(t){return""}},execCommand:function(t,e){if($tx.gecko)try{this.doc.execCommand("styleWithCSS",_FALSE,_FALSE)}catch(t){}try{this.doc.execCommand(t,_FALSE,e)}catch(t){}},execWithMarker:function(t){var e=new Trex.Canvas.Marker(this);this.bookmarkTo();try{e.paste(),e.backup(),t(e)}catch(t){console.log(t,t.stack)}finally{e.remove()}},focus:function(){this.doc.body.focus()},blur:function(){_WIN.focus()},focusOnTop:function(){this.focus(),this.selectFirstText(this.doc.body),this.doc.body.scrollTop=0},selectFirstText:function(t){var e=$tom.top(t),o=this.createGoogRangeFromNodes(e,0,e,0);o.select()},focusOnBottom:function(){this.focus(),this.moveCaretTo(this.doc.body,_FALSE),this.doc.body.scrollTop=this.doc.body.scrollHeight},moveCaretTo:function(t,e){t&&(this.focus(),this.bookmarkInto(t,e),this.bookmark.select(this.txSelection))},moveCaretWith:function(t){if(t){var e=this.findNode(t);e&&(this.focus(),this.bookmark.saveNextTo(e),this.bookmark.select(this.txSelection))}},selectAround:function(t){t&&(this.focus(),this.bookmark.saveAroundNode(t),this.bookmark.select(this.txSelection))},bookmarkInto:function(t,e){t&&(e=e==_NULL?_TRUE:e,e?this.bookmark.saveIntoFirst(t):this.bookmark.saveIntoLast(t))},bookmarkToPrevious:function(t){t&&this.bookmark.savePreviousTo(t)},bookmarkToNext:function(t){t&&this.bookmark.saveNextTo(t)},bookmarkTo:function(t){t=t||this.txSelection.getRange(),this.bookmark.save({startContainer:t.startContainer,startOffset:t.startOffset,endContainer:t.endContainer,endOffset:t.endOffset})},bookmarkWithMarker:function(t){this.bookmark.saveWithMarker(t)},restore:function(){this.bookmark.select(this.txSelection)},create:function(){for(var t=arguments[0],e=this.newNode(t),o=1;o<arguments.length;o++){var n=arguments[o];if(n.nodeType)$tom.append(e,n);else if("string"==typeof n||"number"==typeof n)e.innerHTML+=n;else if("array"==typeof n)for(var r=0;r<n.length;r++)$tom.append(e,n[r]);else $tom.applyAttributes(e,n)}return e},pasteNode:function(t,e,o){if(t){if(t.length||(t=[].concat(t)),this.txSelection.collapse(_FALSE),e){var n,r,i,s=this;this.execWithMarker(function(e){i=$tom.divideParagraph(e.endMarker);var a=$tom.kindOf(i,"p,li,dd,dt,h1,h2,h3,h4,h5,h6");if(a?(n=$tom.previous(i),r=$tom.clone(i)):(i=s.newNode("p"),$tom.insertAt(i,e.endMarker),r=s.newNode("p")),$tom.insertAt(r,i),t.each(function(t){$tom.append(r,t)}),o&&$tom.applyAttributes(r,o),1==t.length){var c=t[0],u=$tom.kindOf(c,"table,hr,blockquote,pre,h1,h2,h3,h4,h5,h6,div"),h=$tom.isTagName(r,"p");u&&h&&$tom.unwrap(r)}}),n&&($tom.hasData(n)||this.stuffNode(n)),this.stuffNode(i),this.bookmark.saveIntoFirst(i)}else{var a=this;this.executeUsingCaret(function(e,o){var n=o.getCaret(_FALSE),r=o.getCaret(_FALSE),i=$tx.msie_nonstd?n:_NULL;t.each(function(t){e.insertNode(t,i)}),r&&r.nextSibling&&a.moveCaretTo(r.nextSibling,0)})}return t[0]}},pasteContent:function(t,e,o){var n=this.create("div");n.innerHTML=t;var r=$tom.children(n);return this.pasteNode(r,e,o)},replace:function(t,e,o){return this.bookmark.saveAroundNode(t),$tom.replace(t,this.create(e,o))},blocks:function(t){var e=[],o=t();if(this.hasControl()){var n=this.getControl();$tom.kindOf(n.parentNode,o)&&e.push(n.parentNode)}else{var r=this;this.execWithMarker(function(t){for(var n,i=r.getBlockRangeIterator(o,t.startMarker,t.endMarker);i.hasNext();)n=i.next(),$tom.kindOf(n,"#tx_start_marker,#tx_end_marker")||e.push(n)})}return e},inlines:function(t){var e=[],o=t(),n=this,r=function(){return n.create($tom.inlineOf())};if(this.hasControl()){var i=this.getControl();if($tom.kindOf(i,o))e.push(i);else{var s=r();$tom.insertNext(s,i),$tom.append(s,i)}}else this.execWithMarker(function(t){if(t.checkCollapsed()){var i=r();$tom.append(i,n.newDummy()),$tom.insertNext(i,t.startMarker),n.bookmarkTo({startContainer:i,startOffset:1,endContainer:i,endOffset:1}),e.push(i)}else for(var s,a=n.getInlineRangeIterator(o,t.startMarker,t.endMarker);a.hasNext();)s=a.next(),$tom.kindOf(s,"#tx_start_marker,#tx_end_marker")||$tom.kindOf(s,"br")||e.push(s)});return e},controls:function(t){var e=[];return this.hasControl()&&$tom.kindOf(this.getControl(),t())&&e.push(this.getControl()),e},addDummyNbsp:function(){},apply:function(t,e){return t?(t.length||(t=[].concat(t)),t.each(function(t){$tom.applyAttributes(t,e)}),t):_NULL},wrap:function(t,e,o){if(!t)return _NULL;t.length||(t=[].concat(t)),o=o||{};var n=$tom.wrap(this.create(e,o),t);if($tx.msie&&!$tom.nextContent(n)){var r=this.doc.createElement("p");r.innerHTML=$tom.EMPTY_BOGUS,this.doc.body.appendChild(r)}return n},unwrap:function(t){return t?(this.bookmark.saveAroundNode(t),$tom.unwrap(t)):_NULL},createGoogRange:function(){return goog.dom.Range.createFromWindow(this.win)},createGoogRangeFromNodes:function(t,e,o,n){return goog.dom.Range.createFromNodes(t,e,o,n)},executeUsingCaret:function(t){try{var e=this.createGoogRange(),o=e.saveUsingCarets();return t(e,o)}finally{o.isDisposed()||o.restore()}}},Trex.module("observe that @when control elements are focused at",function(t,e,o,n){($tx.webkit||$tx.presto)&&n.observeJob(Trex.Ev.__CANVAS_PANEL_MOUSEDOWN,function(t){var e=n.getProcessor(),o=$tx.element(t);if($tom.kindOf(o,"img,hr,iframe,table")){var r=$tom.find(o,"button");r?e.selectControl(r):e.selectControl(o)}else $tom.kindOf(o,"button")&&e.selectControl(o)})}),Trex.module("bind iframe activate or deactivate event",function(t,e,o,n){n.observeJob(Trex.Ev.__IFRAME_LOAD_COMPLETE,function(t){var e=n.getProcessor(Trex.Canvas.__WYSIWYG_MODE);$tx.observe(t,"beforedeactivate",function(t){e.isRangeInsideWysiwyg=!0,e.lastRange=e.getRange()}),$tx.observe(t,"deactivate",function(t){e.hasControl()||(e.isRangeInsideWysiwyg=!1)}),$tx.observe(t,"activate",function(){e.isRangeInsideWysiwyg=!0,e.lastRange=_NULL})})});