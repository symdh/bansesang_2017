Trex.Table.Selector=Trex.Class.create({SELECTED_CLASS_NAME:"tx_table_selected_cell",SELECTED_CSS_TEXT:"{background:#e9eeff !important}",initialize:function(e){this.canvas=e.getCanvas(),this.wysiwygPanel=this.canvas.getPanel(Trex.Canvas.__WYSIWYG_MODE),this.htmlBody=this.getHtmlBody(),this.isDragging=_FALSE,this.currentTable=_NULL,this.currentTd=_NULL,this.paintedTdArr=[],this.startCellBoundary=new Trex.TableUtil.Boundary,this.endCellBoundary=this.startCellBoundary,this.selectedBoundary=new Trex.TableUtil.Boundary,this.tableIndexer=_NULL,this.applyCss(),this.observeEvent()},getHtmlBody:function(){var e;return e=this.wysiwygPanel.getDocument(),e.body},applyCss:function(){var e;e=this.wysiwygPanel.getDocument(),$tx.applyCSSText(e,"."+this.SELECTED_CLASS_NAME+this.SELECTED_CSS_TEXT)},observeEvent:function(){var e;e=this,this.canvas.observeJob(Trex.Ev.__CANVAS_PANEL_MOUSEDOWN,function(t){var n;n=$tx.element(t),e.onmousedown(n)}),$tx.observe(this.htmlBody,"mousemove",function(t){var n;n=$tx.element(t),e.onmousemove(n)}),this.canvas.observeJob(Trex.Ev.__CANVAS_PANEL_MOUSEUP,function(t){e.onmouseup()});var t;try{t=_WIN.top;t.document}catch(e){t=_WIN}$tx.observe(t,"mouseup",function(t){e.onmouseup()}),this.canvas.observeJob(Trex.Ev.__CANVAS_PANEL_KEYDOWN,function(t){e.isDragging?($tx.stop(t),e.reset()):e.onkeydown(t.ctrlKey,t.keyCode)}),this.canvas.observeJob(Trex.Ev.__CANVAS_DATA_INITIALIZE,function(t){t===Trex.Canvas.__WYSIWYG_MODE&&e.clearSelected()})},onmousedown:function(e){var t,n;this.reset(),this.canvas.config.readonly===_FALSE&&(t=Trex.TableUtil.getClosestByTagNames(["td","th"],e),n=$tom.find(t,".txc-info"),t&&!n&&(this.selectStart(t),this.turnOnDragging()))},onmousemove:function(e){var t,n,r;this.isDragging&&(t=Trex.TableUtil.getClosestByTagNames(["td","th"],e),t?(n=Trex.TableUtil.getClosestByTagNames(["table"],t),n===this.currentTable&&t!==this.currentTd&&(this.selectEnd(t),this.applySelected(),Trex.TableUtil.collapseCaret(this.wysiwygPanel,e))):(r=this.endCellBoundary===this.startCellBoundary,this.currentTd&&r&&(this.selectEnd(this.currentTd),this.applySelected(),Trex.TableUtil.collapseCaret(this.wysiwygPanel,e))))},onmouseup:function(){this.isDragging&&this.turnOffDragging()},onkeydown:function(e,t){var n,r,i;if(e===_FALSE){if(t===$tx.KEY_DELETE)for(n=this.getSelectedTdArr(),r=n.length,i=0;i<r;i+=1)Trex.TableUtil.emptyTd(n[i]);this.reset()}},selectStart:function(e){this.currentTable=Trex.TableUtil.getClosestByTagNames(["table"],e),this.tableIndexer=new Trex.TableUtil.Indexer(this.currentTable),this.startCellBoundary=this.tableIndexer.getBoundary(e),this.endCellBoundary=this.startCellBoundary,this.currentTd=e},selectEnd:function(e){this.endCellBoundary=this.tableIndexer.getBoundary(e),this.currentTd=e},applySelected:function(){this.calculateSelectedBoundary(),this.extendSelectedBoundary(),this.paint()},calculateSelectedBoundary:function(){this.selectedBoundary=new Trex.TableUtil.Boundary,this.selectedBoundary.merge(this.startCellBoundary),this.selectedBoundary.merge(this.endCellBoundary)},extendSelectedBoundary:function(){var e;for(e=this.selectedBoundary.isValid();e;)e=this.oneTimeExtendBoundary()},oneTimeExtendBoundary:function(){var e,t,n,r,i;for(e=this.tableIndexer.getTdArr(this.selectedBoundary),n=e.length,t=0;t<n;t+=1)if(r=this.tableIndexer.getBoundary(e[t]),i=this.selectedBoundary.merge(r))return _TRUE;return _FALSE},paint:function(){var e,t;e=this.tableIndexer.getTdArr(this.selectedBoundary),t=Array.prototype.without.apply(this.paintedTdArr,e),this.paintSelected(e),this.eraseSelected(t)},paintSelected:function(e){var t;t=this,this.paintedTdArr=[],e.each(function(e){$tx.addClassName(e,t.SELECTED_CLASS_NAME),t.paintedTdArr.push(e)})},eraseSelected:function(e){this.removeClassName(e),this.paintedTdArr=Array.prototype.without.apply(this.paintedTdArr,e)},removeClassName:function(e){var t;t=this,e.each(function(e){var n;$tx.removeClassName(e,t.SELECTED_CLASS_NAME),""===e.className&&(n=e.removeAttribute("class"),n===_FALSE&&e.removeAttribute("className"))})},clearSelected:function(){var e;e=$tom.collectAll(this.htmlBody,"."+this.SELECTED_CLASS_NAME),this.removeClassName(e),this.paintedTdArr=[]},resetBoundary:function(){this.startCellBoundary=new Trex.TableUtil.Boundary,this.endCellBoundary=this.startCellBoundary,this.selectedBoundary=new Trex.TableUtil.Boundary},turnOnDragging:function(){this.isDragging=_TRUE},turnOffDragging:function(){this.isDragging=_FALSE},resetDragging:function(){this.isDragging=_FALSE,this.currentTable=_NULL,this.currentTd=_NULL},isDuringSelection:function(){return this.isDragging},getIndexer:function(){return this.tableIndexer},getSelected:function(){return this.selectedBoundary},getSelectedTdArr:function(){return this.selectedBoundary.isValid()?this.tableIndexer.getTdArr(this.selectedBoundary):[]},selectByBoundary:function(e){this.resetBoundary(),this.selectedBoundary=e,this.paint()},selectByTd:function(e,t){this.selectStart(e),this.selectEnd(t),this.applySelected()},reset:function(){this.clearSelected(),this.resetBoundary(),this.resetDragging(),this.reloadIndexer()},reloadIndexer:function(){this.tableIndexer&&this.tableIndexer.reload()},getSizeOfSelected:function(){var e,t,n,r,i;return e=this.getSelectedTdArr(),0<e.length?(t=e[0],n=e[e.length-1],r=$tom.getPosition(t),i=$tom.getPosition(n),{width:i.x+i.width-r.x,height:i.y+i.height-r.y}):{width:0,height:0}}});