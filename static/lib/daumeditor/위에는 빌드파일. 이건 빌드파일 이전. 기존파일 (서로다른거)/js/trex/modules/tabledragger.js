Trex.module("table resize dragger",function(t,e,o,n){n.observeJob(Trex.Ev.__IFRAME_LOAD_COMPLETE,function(){function t(t){return Math.min.apply(Math,t)}function e(){console.log("saveHistory"),n.history.saveHistory()}var o,r,i,f,c,l,a,s,g,d,u,T,x,h,L,p,$,b,m,v,y,E,O,_,N=n.getPanel(Trex.Canvas.__WYSIWYG_MODE),w=N.getDocument(),U=N.getWindow(),P=w.body,C=20,H=$tom.collect(n.wysiwygEl,".tx-table-col-resize-dragger"),S=$tom.collect(n.wysiwygEl,".tx-table-row-resize-dragger"),I=_FALSE,R={TOP:"EDGE_TOP",BOTTOM:"EDGE_BOTTOM",LEFT:"EDGE_LEFT",RIGHT:"EDGE_RIGHT",NONE:"NONE"},B=R.NONE,F=function(){I=_FALSE,T=_NULL,x=_NULL,r=i=_NULL,f=c=_NULL,$=p=b=_NULL,m=v=y=_NULL,h=L=0,g=d=u=0,l=a=s=0},k=function(){if(r=$tom.find(T,"table"),r==_NULL)return _NULL;switch(I=_TRUE,g=r.offsetWidth,B!=R.NONE&&($tx.stop(_),ft()),B){case R.LEFT:G(),J();break;case R.RIGHT:M(),J();break;case R.TOP:D(),et();break;case R.BOTTOM:A(),et()}},G=function(){var t=new Trex.TableUtil.Indexer(r),e=t.getBoundary(T);e.left>0&&(p=t.getTdArrHasRight(e.left-1),$=t.getTdArrHasLeft(e.left))},M=function(){var t=new Trex.TableUtil.Indexer(r),e=t.getBoundary(T),o=t.getColSize();p=t.getTdArrHasRight(e.right),e.right<o-1&&($=t.getTdArrHasLeft(e.right+1))},D=function(){var t=new Trex.TableUtil.Indexer(r),e=t.getBoundary(T);b=t.getTdArrHasBottom(e.top-1)},A=function(){var t=new Trex.TableUtil.Indexer(r),e=t.getBoundary(T);b=t.getTdArrHasTop(e.bottom)},W=function(){switch(B){case R.LEFT:case R.RIGHT:Z();break;case R.TOP:case R.BOTTOM:nt()}},Y=function(){I?(x=q(),X()):z()},X=function(){switch(B){case R.LEFT:case R.RIGHT:j();break;case R.TOP:case R.BOTTOM:ot()}},z=function(){var t=$tom.find($tx.element(_),"td"),e=$tom.find(t,".txc-info");t&&!e?(T=t,B=it(T),ft()):(B=R.NONE,ft())},q=function(){var t=_NULL;switch(B){case R.LEFT:case R.RIGHT:t=H;break;case R.TOP:case R.BOTTOM:t=S}return t},J=function(){I=_TRUE,m=[],v=[];var e=0;if(p){for(e=0;e<p.length;e++)m.push(p[e].offsetWidth);for(l=t(m),e=0;e<p.length;e++)if(l==m[e]){f=p[e];break}}if($){for(e=0;e<$.length;e++)v.push($[e].offsetWidth);for(a=t(v),e=0;e<$.length;e++)if(a==v[e]){c=$[e];break}}d=$tx.getCoordsTarget(x).left},j=function(){if(I){var t,e=parseInt(E-$tom.getScrollLeft(w)-d);f&&c&&(t=K(f,e)),f&&c==_NULL&&(t=Q(f,e)),f==_NULL&&c&&(t=V(c,e)),t&&$tx.setStyle(x,{left:t.toPx()})}},K=function(t,e){var o,n,r,i,f;return o=l+a,n=l+e,r=a-e,i=$tx.getCoordsTarget(t),n>=C&&r>=C?f=E-$tom.getScrollLeft(w):n<=C?(n=C,r=o-n,f=i.left-$tom.getScrollLeft(w)+n):r<=C&&(r=C,n=o-r,f=i.left-$tom.getScrollLeft(w)+n),h=n-l,f},Q=function(t,e){var o,n,r;return o=l+e,n=$tx.getCoordsTarget(t),o<C&&(o=C),r=n.left-$tom.getScrollLeft(w)+o,h=o-l,r},V=function(t,e){var o,n,r;return o=a-e,n=$tx.getCoordsTarget(t),o<C&&(o=C),r=n.left+o,h=a-o,r},Z=function(){tt(),F(),z(),e()},tt=function(){var t;if(p)for(t=0;t<p.length;t++)p[t].style.width=(m[t]+h).toPx();if($)for(t=0;t<$.length;t++)$[t].style.width=(v[t]-h).toPx();p&&$==_NULL&&at()},et=function(){if(I=_TRUE,s=T.offsetHeight,y=[],b){var e;for(e=0;e<b.length;e++)y.push(parseInt(b[e].offsetHeight));for(s=t(y),e=0;e<b.length;e++)s==y[e]&&(i=b[e])}u=$tx.getCoordsTarget(x).top},ot=function(){if(I){var t=O-$tom.getScrollTop(w)-u,e=s+parseInt(t),o=$tx.getCoordsTarget(i),n=_NULL;e<0?(e=0,n=o.top+e-$tom.getScrollTop(w)):n=O-$tom.getScrollTop(w),n&&$tx.setStyle(x,{top:n.toPx()}),L=e-s}},nt=function(){rt(),F(),z(),e()},rt=function(){if(b)for(var t=0;t<b.length;t++){var e=y[t]+L;e<0&&(e=20),b[t].style.height=e.toPx()}};!function(){var t=w.createElement("div");P.appendChild(t),t.style.width=t.style.paddingLeft="1px",o=2===t.offsetWidth,P.removeChild(t)}();var it=function(t){var e,n=R.NONE;if("getBoundingClientRect"in document.documentElement)try{var r=t.ownerDocument,i=r.documentElement,f=r.body,c=t.getBoundingClientRect(),l=$tom.getWindow(r),a=i.clientTop||f.clientTop||0,s=i.clientLeft||f.clientLeft||0,g=l.pageYOffset||o&&i.scrollTop||f.scrollTop,d=l.pageXOffset||o&&i.scrollLeft||f.scrollLeft,u=c.top+g-a,T=c.left+d-s;e={top:u,left:T,bottom:u+t.offsetHeight,right:T+t.offsetWidth}}catch(t){e=_NULL}return e||(e=$tx.getCoordsTarget(t)),E-e.left<5&&0!=t.cellIndex?n=R.LEFT:e.right-5<E?n=R.RIGHT:O-e.top<5&&0!=t.parentNode.rowIndex?n=R.TOP:e.bottom-5<O&&(n=R.BOTTOM),n},ft=function(){n.query(function(t){if(t.table)switch((t.table.isDuringSelection()||n.config.readonly)&&(B=R.NONE),B){case R.LEFT:case R.RIGHT:$tx.hide(S),$tx.show(H),ct(H),x=H;break;case R.TOP:case R.BOTTOM:$tx.hide(H),$tx.show(S),lt(S),x=S;break;case R.NONE:$tx.hide(H),$tx.hide(S)}})},ct=function(t){if(t!=_NULL){var e;I?(e=$tx.getCoordsTarget(t).left,$tx.setStyle(t,{width:"2px",height:N.el.clientHeight.toPx(),border:"1px dotted #81aFFC",background:"",left:e.toPx()}),$tx.setOpacity(H,1)):(e=E-$tom.getScrollLeft(w),$tx.setStyle(t,{width:"2px",height:N.el.clientHeight.toPx(),border:"",background:"#fff",left:e.toPx()}),$tx.setOpacity(H,0))}},lt=function(t){if(t!=_NULL){var e=_NULL;I?(e=$tx.getCoordsTarget(t).top,$tx.setStyle(t,{height:"2px",border:"1px dotted #81aFFC",background:"",top:e.toPx()}),$tx.setOpacity(S,1)):(e=O-$tom.getScrollTop(w),$tx.setStyle(t,{height:"2px",border:"",background:"#fff",top:e.toPx()}),$tx.setOpacity(S,0))}},at=function(){var t=0;g&&(t=parseInt(g)+h,r.width=t.toPx(),r.style.width=t.toPx())},st=function(){$tx.observe(_DOC.body,"mouseup",function(t){gt(t),W()}),$tx.msie?($tx.observe(P,"mousemove",function(t){gt(t),Y()}),$tx.observe(P,"mouseup",function(t){gt(t),W()})):($tx.observe(U,"mousemove",function(t){gt(t),Y()}),$tx.observe(U,"mouseup",function(t){gt(t),W()})),$tx.safari&&$tx.observe(_DOC.body,"mousemove",function(t){I&&(dt(t),Y())}),$tx.observe(H,"mousedown",function(t){gt(t),k()}),$tx.observe(S,"mousedown",function(t){gt(t),k()})},gt=function(t){_=t,E=ut(_),O=Tt(_)},dt=function(t){_=t,E=ut(_)-$tx.getCoords(n.wysiwygEl).left+w.body.scrollLeft,O=Tt(_)-$tx.getCoords(n.wysiwygEl).top+w.body.scrollTop},ut=function(t){var e=0;return t=t||U.event,t.pageX?e=t.pageX:t.clientX&&(e=t.clientX+w.body.scrollLeft+w.documentElement.scrollLeft),e},Tt=function(t){var e=0;return t=t||U.event,t.pageY?e=t.pageY:t.clientY&&(e=t.clientY+w.body.scrollTop+w.documentElement.scrollTop),e};F(),st()})});