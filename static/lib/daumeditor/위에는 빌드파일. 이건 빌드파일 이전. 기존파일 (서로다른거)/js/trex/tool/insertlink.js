TrexConfig.addTool("link",{wysiwygonly:_TRUE,sync:_FALSE,status:_TRUE}),TrexMessage.addMsg({"@insertlink.cancel.image":"#iconpath/btn_cancel.gif?v=2","@insertlink.confirm.image":"#iconpath/btn_confirm.gif?v=2","@insertlink.invalid.url":"URL을 입력해주세요.","@insertlink.link.alt":"[#{title}]로 이동합니다.","@insertlink.remove.image":"#iconpath/btn_remove.gif?v=2","@insertlink.title":"선택된 부분에 걸릴 URL주소를 넣어주세요.","@insertlink.onclick.target":"클릭 시","@insertlink.target.blank":"새 창","@insertlink.target.self":"현재창","@insertlink.class.name":"tx-link"}),Trex.Tool.Link=Trex.Class.create({$const:{__Identity:"link"},$extend:Trex.Tool,oninitialized:function(){var e=this,t=this.canvas,n=function(e){t.isWYSIWYG()?e?t.execute(function(t){var n,i,a={href:e.link,target:e.target?e.target:"_blank",className:e.className};if(t.findNode("a"))n=t.findNode("a"),$tom.applyAttributes(n,a);else if(t.hasControl())i=t.controls(function(){return"img"}),$tom.wrap(t.create("a",a),i);else if(t.isCollapsed()){n=t.create("a",a);var r=t.doc.createTextNode(e.link);n.appendChild(r),t.pasteNode(n,_FALSE)}else i=t.inlines(function(){return"%text,img,a,%inline"}),i.each(function(e){if($tom.hasUsefulChildren(e,_TRUE))if($tom.kindOf(e,"a"))$tom.applyAttributes(e,a);else if($tom.kindOf(e,"img"))$tom.wrap(t.create("a",a),[e]);else{var n=$tom.getStyleText(e),i=$tom.collectAll(e,"a");i.each(function(e){$tom.moveChildToParent(e),$tom.remove(e)});var r=t.create("a",a);$tom.setStyleText(r,n),$tom.replace(e,r)}else $tom.remove(e)})}):t.execute(function(e){var t=e.findNode("a");t&&e.unwrap(t)}):t.execute(function(t){t.insertTag('<a href="'+e.link+'" target="'+e.target+'" >',"</a>")})},i="",a=function(){return t.isWYSIWYG()?t.query(function(e){var t,n,a,r;if(t=e.findNode("a")){if(n=$tom.getAttribute(t,"href"))return a=$tom.getAttribute(t,"target"),{exist:_TRUE,value:n,target:a}}else if(r=e.getText(),/^\w+\:\/\/\S+/.test(r))return{exist:_FALSE,value:r};return{exist:_FALSE,value:i}}):{exist:_FALSE,value:i}};this.weave.bind(this)(new Trex.Button(this.buttonCfg),new Trex.Menu.Link(this.menuCfg),n,a);var r=function(t){e.button.onMouseDown(t)};this.bindKeyboard({ctrlKey:_TRUE,keyCode:75},r)}}),Trex.MarkupTemplate.add("menu.insertlink",['<div class="tx-menu-inner">',"    <dl>","        <dt>","            @insertlink.title","        </dt>","        <dd>",'            <input type="text" class="tx-text-input"/>',"        </dd>",'        <dd class="tx-rp">','            <span class="tx-text tx-first">@insertlink.onclick.target</span>','            <span><input type="radio" name="tx-insertlink-win" value="_blank"/><span class="tx-text">@insertlink.target.blank</span></span>','            <span><input type="radio" name="tx-insertlink-win" value="_top"/><span class="tx-text">@insertlink.target.self</span></span>',"        </dd>",'        <dd class="tx-hr">',"            <hr/>","        </dd>","        <dd>",'            <img width="32" height="21" src="@insertlink.confirm.image"/>','            <img width="32" height="21" src="@insertlink.cancel.image"/>','            <img width="51" height="21" src="@insertlink.remove.image" style="display: none;"/>',"        </dd>","    </dl>","</div>"].join("")),Trex.Menu.Link=Trex.Class.create({$extend:Trex.Menu,ongenerated:function(){var e=this.elMenu;Trex.MarkupTemplate.get("menu.insertlink").evaluateToDom({},e);var t=$tom.collectAll(e,".tx-rp input"),n=this.newInput=t[0];$tx.observe(n,"click",function(){n.checked="checked",i.checked=""});var i=this.currInput=t[1];$tx.observe(i,"click",function(){i.checked="checked",n.checked=""});var a=this.urlValidator,r=this.elInput=$tom.collect(e,"input.tx-text-input");$tx.observe(r,"keydown",function(e){if(13==e.keyCode){var t=a(r.value);if(!t)return alert(TXMSG("@insertlink.invalid.url")),void $tx.stop(e);var s=n.checked?n.value:i.value;this.onSelect(e,{link:t,target:s,className:TXMSG("@insertlink.class.name")}),$tx.stop(e)}}.bindAsEventListener(this));var s=$tom.collectAll(e,"img");$tx.observe(s[0],"click",function(e){var t=a(r.value);if(!t)return alert(TXMSG("@insertlink.invalid.url")),void $tx.stop(e);var s=n.checked?n.value:i.value;this.onSelect(e,{link:t,target:s,className:TXMSG("@insertlink.class.name")}),$tx.stop(e)}.bind(this)),$tx.observe(s[1],"click",function(){this.onCancel()}.bindAsEventListener(this));var l=$tx(s[2]);$tx.observe(l,"click",function(e){this.onSelect(e,_NULL)}.bindAsEventListener(this)),this.toggleRemoveBtn=function(e){l.style.display=e?"":"none"}},onregenerated:function(){var e=this.elInput,t=this.initHandler();e.value=t.value,"_self"==t.target||"_top"==t.target?(this.currInput.checked="checked",this.newInput.checked=""):(this.newInput.checked="checked",this.currInput.checked=""),this.toggleRemoveBtn(t.exist),e.focus(),$tx.msie_nonstd&&setTimeout(function(){try{e.focus();var t=_DOC.selection.createRange();t.move("character",e.value.length),t.select()}catch(e){}},100)},urlValidator:function(e){if(!e)return _FALSE;if(e=e.trim(),0==e.length)return _FALSE;var t=/^[a-z0-9+.-]+:|^\/\//i;return t.test(e)?e:"http://"+e}});