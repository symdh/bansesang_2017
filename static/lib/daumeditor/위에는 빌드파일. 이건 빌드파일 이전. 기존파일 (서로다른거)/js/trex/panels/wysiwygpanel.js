!function(){function t(t){for(var e=["color","fontSize","fontFamily","lineHeight"],o=Object.clone(t),i=0;i<e.length;i++)delete o[e[i]];return o}function e(t){return t.replace(Trex.__WORD_JOINER_REGEXP,"")}function o(t){return $tx.msie&&(t=t.replace(/(<script|<style)/i,Trex.__WORD_JOINER+"$1")),t}function i(t){if($tx.msie_nonstd)for(var e=$tom.collectAll(t,"p,li"),o=0,i=e.length;o<i;o++){var n=e[o];if(0===$tom.getLength(n)&&"p"!==n.tagName.toLowerCase())try{n.innerHTML="&nbsp;"}catch(t){}1===$tom.getLength(n)&&"&nbsp;"===n.innerHTML&&(n.innerHTML="")}}Trex.Canvas.WysiwygPanel=Trex.Class.create({$extend:Trex.Canvas.BasedPanel,$const:{__MODE:Trex.Canvas.__WYSIWYG_MODE,EVENT_BINDING_DELAY:500},initialize:function(t,e){this.$super.initialize(t,e),this.canvasConfig=e,this.iframe=this.el,this.wysiwygWindow=this.iframe.contentWindow,this.onceWysiwygFocused=!1;var o=this,i=new Trex.WysiwygIframeLoader(this.iframe,e.wysiwygCatalystUrl,e.doctype);i.load(function(e){if(o.wysiwygDoc=e,o.initializeSubModules(e),installHyperscript(o.wysiwygWindow,o.wysiwygDoc),o.makeEditable(),o.applyBodyStyles(o.canvasConfig.styles),o.applyCustomCssText(o.canvasConfig.customCssText),o.clearContent(),o.bindEvents(t),Editor.__PANEL_LOADED=_TRUE,$tx.observe(o.wysiwygWindow,"focus",function(){o.onceWysiwygFocused||(o.onceWysiwygFocused=!0)}),$tx.msie_nonstd){var i=o.wysiwygDoc.getElementsByTagName("html");i&&i[0]&&$tx.observe(i[0],"click",function(e){var n=$tx.element(e);t.canHTML()&&i[0]==n&&o.focus()})}t.fireJobs(Trex.Ev.__IFRAME_LOAD_COMPLETE,e)})},_bodyHeight:0,_bodyContentHeight:0,initializeSubModules:function(t){var e=this.wysiwygWindow;this.processor=new Trex.Canvas.ProcessorP(e,t),this.webfontLoader=new Trex.WebfontLoader(t,this.canvasConfig)},makeEditable:function(){if(!this.canvasConfig.readonly)if(this.wysiwygDoc.body.contentEditable)this.wysiwygDoc.body.contentEditable=_TRUE;else{var t=this;setTimeout(function(){try{t.wysiwygDoc.designMode="On",$tx.gecko&&t.wysiwygDoc.execCommand("enableInlineTableEditing",_FALSE,_FALSE)}catch(e){t.designModeActivated=_FALSE}},10)}},getName:function(){return this.constructor.__MODE},getWindow:function(){return this.wysiwygWindow},getDocument:function(){return this.wysiwygDoc},getContent:function(){return this.wysiwygDoc.body.innerHTML},setContent:function(t){t=this.doPreFilter(t),this.setBodyHTML(t),this.doPostFilter(this.wysiwygDoc.body)},doPreFilter:function(t){return t&&(t=e(t),t=o(t)),t},setBodyHTML:function(t){this.wysiwygDoc.body.innerHTML=t||$tom.EMPTY_PARAGRAPH_HTML},doPostFilter:function(t){i(t)},clearContent:function(){this.setContent("")},getScrollTop:function(){return $tom.getScrollTop(this.wysiwygDoc)},setScrollTop:function(t){$tom.setScrollTop(this.wysiwygDoc,t)},getScrollLeft:function(){return $tom.getScrollLeft(this.wysiwygDoc)},getProcessor:function(){return this.processor},ifProcessorReady:function(t){this.processor&&t(this.processor)},getStyle:function(t){return $tx.getStyle(this.wysiwygDoc.body,t)},addStyle:function(t){$tx.setStyleProperty(this.wysiwygDoc.body,t)},setBodyStyle:function(e,o){var i=t(o);$tx.setStyleProperty(e.body,i)},setFontStyle:function(t,e){var o=Object.extend(e,{browser:$tx.browser,pMarginZero:this.canvasConfig.pMarginZero?"true":"false"}),i=new Template(["#{if:pMarginZero=='true'}p { margin:0; padding:0; }#{/if:pMarginZero}","body, td, button { color:#{color}; font-size:#{fontSize}; font-family:#{fontFamily}; line-height:#{lineHeight}; }","a, a:hover, a:link, a:active, a:visited { color:#{color}; }","div.txc-search-border { border-color:#{color}; }","div.txc-search-opborder { border-color:#{color}; }","img.tx-unresizable { width: auto !important; height: auto !important; }","button a { text-decoration:none #{if:browser=='firefox'}!important#{/if:browser}; color:#{color} #{if:browser=='firefox'}!important#{/if:browser}; }"].join("\n")).evaluate(o);$tx.applyCSSText(t,i)},applyBodyStyles:function(t){var e=this.wysiwygDoc;try{this.setFontStyle(e,t),this.setBodyStyle(e,t)}catch(t){}},applyCustomCssText:function(t){if(t){var e=this.wysiwygDoc;try{$tx.applyCSSText(e,t)}catch(t){}}},setRule:function(t,e){var o,i,n;try{o=this.wysiwygDoc.getElementById("txStyleForSetRule"),i=o.sheet?o.sheet:o.styleSheet,n=i.cssRules?i.cssRules:i.rules,i.insertRule?(0<n.length&&i.deleteRule(0),t&&i.insertRule(t+"{"+e+"}",0)):i.addRule&&(0<n.length&&i.removeRule(0),t&&i.addRule(t,e,0))}catch(t){}},bindEvents:function(t){var e=new Trex.WysiwygEventBinder(this.wysiwygWindow,this.wysiwygDoc,t,this.processor);setTimeout(function(){e.bindEvents()},this.constructor.EVENT_BINDING_DELAY)},getPanel:function(t){var e=t.initializedId||"";return $must("tx_canvas_wysiwyg"+e,"Trex.Canvas.WysiwygPanel")},setHeightBody:function(t){var e=this.wysiwygWindow.document.body,o=parseInt($tx.getStyle(e,"margin-top"))+parseInt($tx.getStyle(e,"padding-top")),i=parseInt($tx.getStyle(e,"margin-bottom"))+parseInt($tx.getStyle(e,"padding-bottom"));t=parseInt(t)-o-i,e.style.height=t.toPx(),this._bodyHeight=t},setPanelHeight:function(t){function e(i){if(0!==i)try{o.setHeightBody(t)}catch(t){setTimeout(e.bind(this,i-1),30)}}var o=this;e(10),o.$super.setPanelHeight(t)},getHolder:function(t){var e=t.initializedId||"";return $must("tx_canvas_wysiwyg_holder"+e,"Trex.Canvas.WysiwygPanel")},focus:function(){this.ifProcessorReady(function(t){t.focus()})},ensureFocused:function(){this.onceWysiwygFocused||(this.onceWysiwygFocused=!0,this.focus())},show:function(){this.$super.show(),this.ifProcessorReady(function(t){setTimeout(function(){try{t.focusOnTop()}catch(t){}},100)})},hide:function(){this.ifProcessorReady(function(t){t.blur()}),this.$super.hide()},includeWebfontCss:function(t){this.webfontLoader.load(t)},getUsedWebfont:function(){return this.webfontLoader.getUsed()},getPositionByNode:function(t){var e=new Trex.WysiwygRelative(this.iframe);return e.getRelative(t)}})}(),Trex.module("canvas set focus on mousedown event. only IE.",function(t,e,o,i,n){$tx.msie_std&&i.observeJob(Trex.Ev.__CANVAS_PANEL_MOUSEUP,function(t){if($tx.isLeftClick(t)){var e=$tx.element(t).tagName;"html"==e.toLocaleLowerCase()&&i.focusOnBottom()}})}),Trex.module("auto body resize",function(t,e,o,i,n){i.observeJob(Trex.Ev.__IFRAME_LOAD_COMPLETE,function(){function t(){if(i.isWYSIWYG()){var t=n.getDocument(),s=t.body,r=s.innerHTML;if(e!==r){e=r,s.style.height="";var c=$tx.getDimensions(s).height;n._bodyContentHeight=c,c<o&&(s.style.height=o.toPx())}}}var e="",o=0,n=i.getPanel("html");o=n._bodyHeight,i.observeJob("canvas.height.change",function(t){o=parseInt(n._bodyHeight)}),setInterval(t,200)})});