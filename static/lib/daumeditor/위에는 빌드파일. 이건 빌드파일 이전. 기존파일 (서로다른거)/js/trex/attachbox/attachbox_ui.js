TrexMessage.addMsg({"@attacher.ins":"삽입","@attacher.del":"삭제","@attacher.preview.image":"#iconpath/pn_preview.gif","@attacher.delete.confirm":"삭제하시면 본문에서도 삭제됩니다. 계속하시겠습니까?","@attacher.delete.all.confirm":"모든 첨부 파일을 삭제하시겠습니까? 삭제하시면 본문에서도 삭제됩니다.","@attacher.exist.alert":"이미 본문에 삽입되어 있습니다."}),Trex.install("attachbox.onAttachBoxInitialized @if config.sidebar.attachbox.show = true",function(e,t,a,i,s){var r=e.getAttachBox();s.sidebar.attachbox.show==_TRUE&&(Object.extend(r,Trex.I.AttachBox),r.onAttachBoxInitialized(s,i,e))}),Trex.I.AttachBox={useBox:_TRUE,isDisplay:_FALSE,lastSelectedEntry:_NULL,onAttachBoxInitialized:function(e,t){var a=this;this.canvas=t;var i=e.initializedId?e.initializedId:"";this.elBox=$must("tx_attach_div"+i,"Trex.I.AttachBox"),this.elList=$must("tx_attach_list"+i,"Trex.I.AttachBox");var s=$must("tx_attach_preview"+i,"Trex.I.AttachBox");this.elPreviewKind=$tom.collect(s,"p");var r=$tom.collect(s,"img");this.elPreviewImg=r,this.imageResizer=new Trex.ImageResizer(r,{maxWidth:147,maxHeight:108,defImgUrl:TXMSG("@attacher.preview.image"),onComplete:function(e,t){r.style.marginTop=Math.floor((108-t)/2).toPx()}}),this.elDelete=$tom.collect("#tx_attach_delete"+i+" a"),$tx.observe(this.elDelete,"click",function(){e.sidebar.attachbox.confirmForDeleteAll?a.onDeleteAll(!1):a.onDeleteAll(!0)}),"function"==typeof showAttachBox&&this.observeJob(Trex.Ev.__ATTACHBOX_SHOW,function(){showAttachBox()}),"function"==typeof hideAttachBox&&this.observeJob(Trex.Ev.__ATTACHBOX_HIDE,function(){hideAttachBox()});var l=$must("tx_upload_progress"+i,"Trex.I.AttachBox");this.elProgress=l,this.elProgressPercent=$tom.collect(l,"div"),this.elProgressTicker=$tom.collect(l,"p"),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_ADDED,function(e){a.registerEntryNode(e),a.displayBox()}),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_MODIFIED,function(e){a.modifyEntryNode(e),a.refreshPreview()}),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_REMOVED,function(e){a.removeEntryNode(e),a.displayBox(),a.lastSelectedEntry&&a.lastSelectedEntry.key==e.key&&a.refreshPreview()}),this.observeJob(Trex.Ev.__ENTRYBOX_ALL_ENTRY_REMOVED,function(){a.datalist.each(function(e){a.removeEntryNode(e,_TRUE)}),a.displayBox(),a.lastSelectedEntry&&a.refreshPreview()}),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_REFRESH,function(e){a.displayBox(),a.refreshEntryNode(e)});var o=$tx("tx_attach_up_size"+i),n=$tx("tx_attach_max_size"+i),c=$tx("tx_attach_group_used_size"+i),h=$tx("tx_attach_group_max_size"+i);this.observeJob(Trex.Ev.__ENTRYBOX_CAPACITY_UPDATE,function(){var t=e.sidebar.capacity;t.show!=_FALSE&&(o&&(o.innerText=t.uploaded.toByteUnit()),n&&(n.innerText=t.available.toByteUnit()),t.group&&(c&&(c.innerText=(t.group.used+t.uploaded).toByteUnit()),h&&(h.innerText=t.group.maximum.toByteUnit())))})},onDeleteAll:function(e){0!==this.datalist.length&&(e||confirm(TXMSG("@attacher.delete.all.confirm")))&&(this.datalist.each(function(e){e.deletedMark==_FALSE&&e.execRemove()}),this.initPreviewImage())},checkDisplay:function(){return this.isDisplay},setDisplay:function(e){this.isDisplay=e},displayBox:function(){for(var e=_FALSE,t=0;t<this.datalist.length;t++)this.datalist[t].deletedMark==_FALSE&&(e=_TRUE);this.isDisplay!=e&&(e?($tx.show(this.elBox),this.fireJobs(Trex.Ev.__ATTACHBOX_SHOW,_TRUE)):($tx.hide(this.elBox),this.fireJobs(Trex.Ev.__ATTACHBOX_HIDE,_FALSE)),this.isDisplay=e)},registerEntryNode:function(e){var t=tx.li({className:"type-"+e.type});e.actor.boxonly&&$tx.addClassName(t,"tx-boxonly"),this.elList.appendChild(t),e.elData=t,e.makeSelection=function(t){t?this.showEntryThumb(e):this.hideEntryThumb(e)}.bind(this),$tx.observe(t,"mouseover",this.onEntryMouseOver.bind(this,e)),$tx.observe(t,"mouseout",this.onEntryMouseOut.bind(this,e));var a=tx.dl();t.appendChild(a);var i=tx.dt({className:"tx-name",unselectable:"on"},e.boxAttr.name);e.elName=i,a.appendChild(i),$tx.observe(t,"click",function(t){var a=$tx.element(t);"tx-delete"!=a.className&&"tx-insert"!=a.className&&(t.ctrlKey?this.clickEntryWithCtrl(e):t.shiftKey?this.clickEntryWithShift(e):this.clickEntry(e),"image"==e.actor.name&&(e.data.width&&e.data.height||new Trex.ImageScale(e.data)))}.bind(this),_FALSE);var s=tx.dd({className:"tx-button"});a.appendChild(s);var r=tx.a({className:"tx-delete"},TXMSG("@attacher.del"));s.appendChild(r),$tx.observe(r,"click",function(){confirm(TXMSG("@attacher.delete.confirm"))&&e.execRemove()},_FALSE);var l=tx.a({className:"tx-insert"},TXMSG("@attacher.ins"));e.elInsert=l,s.appendChild(l),$tx.observe(l,"click",function(){e.existStage&&!e.actor.config.multipleuse?alert(TXMSG("@attacher.exist.alert")):e.execAppend()},_FALSE)},changeState:function(e){var t=e.existStage;t&&!e.actor.config.multipleuse?$tx.addClassName(e.elData,"tx-existed"):$tx.removeClassName(e.elData,"tx-existed")},modifyEntryNode:function(e){e.elName.innerText=e.boxAttr.name},removeEntryNode:function(e,t){t?e.elData.parentNode.removeChild(e.elData):e.deletedMark&&$tx.hide(e.elData)},refreshEntryNode:function(e){e.deletedMark?$tx.hide(e.elData):$tx.show(e.elData)},refreshPreview:function(){for(var e=0,t=this.datalist.length-1;e<t;++e){var a=this.datalist[e];if(this.lastSelectedEntry&&this.lastSelectedEntry.key==a.key&&0==a.deleteMark)return this.setPreivewImage(a),_TRUE}for(var e=0,t=this.datalist.length-1;e<t;++e){var a=this.datalist[e];if(0==a.deletedMark&&$tx.hasClassName(a.elData,"tx-clicked"))return this.setPreivewImage(a),_TRUE}return this.initPreviewImage(),_FALSE},setPreivewImage:function(e){this.imageResizer.execResize(e.boxAttr.image),this.lastSelectedEntry=e},initPreviewImage:function(){this.imageResizer.execResize(TXMSG("@attacher.preview.image")),this.lastSelectedEntry=_NULL},showEntryThumb:function(e){$tx.addClassName(e.elData,"tx-clicked"),$tx.removeClassName(e.elData,"tx-hovered")},hideEntryThumb:function(e){$tx.removeClassName(e.elData,"tx-clicked")},onEntryMouseOver:function(e){$tx.addClassName(e.elData,"tx-hovered")},onEntryMouseOut:function(e){$tx.removeClassName(e.elData,"tx-hovered")},startUpload:function(){this.elProgressPercent.style.width="0".toPx(),$tx.setStyle(this.elList,{opacity:.3}),$tx.show(this.elProgress)},doUpload:function(e){var t=300;this.elProgressPercent.style.width=Math.floor(t*(isNaN(e)?0:.01*parseFloat(e))).toPx(),this.elProgressTicker.innerText=Math.floor(isNaN(e)?0:parseFloat(e))+"%"},endUpload:function(){$tx.hide(this.elProgress),$tx.setStyle(this.elList,{opacity:1})},clickEntry:function(e){if(this.lastSelectedEntry){if(this.lastSelectedEntry.key==e.key)return;this.datalist.each(function(e){e.makeSelection(_FALSE)})}this.elPreviewKind.className=e.boxAttr.className?e.boxAttr.className:"",e.makeSelection(_TRUE),this.setPreivewImage(e)},clickEntryWithCtrl:function(e){$tx.hasClassName(e.elData,"tx-clicked")?(e.makeSelection(_FALSE),this.refreshPreview()):(this.elPreviewKind.className=e.boxAttr.className?e.boxAttr.className:"",e.makeSelection(_TRUE),this.setPreivewImage(e))},clickEntryWithShift:function(e){if($tx.hasClassName(e.elData,"tx-clicked"))e.makeSelection(_FALSE),this.lastSelectedEntry=_NULL;else{var t,a=this.getIndexOf(e);this.lastSelectedEntry&&(t=this.getIndexOf(this.lastSelectedEntry));var i=t,s=a;a==t?i=s=a:a<t&&(i=a,s=t),this.elPreviewKind.className=e.boxAttr.className?e.boxAttr.className:"";for(var r=i;r<s+1;r++)this.datalist[r].makeSelection(_TRUE);this.setPreivewImage(e)}},getIndexOf:function(e){var t,a;for(t=0;t<this.datalist.length;t++)if(this.datalist[t]===e){a=_TRUE;break}return a?t:-1},getSelectedList:function(e){var t,a=[];return t=e?this.getAttachments(e):this.datalist,t.each(function(e){$tx.hasClassName(e.elData,"tx-clicked")&&a.push(e)}),a},removeSelection:function(e){e.each(function(e){$tx.removeClassName(e.elData,"tx-clicked")})}};