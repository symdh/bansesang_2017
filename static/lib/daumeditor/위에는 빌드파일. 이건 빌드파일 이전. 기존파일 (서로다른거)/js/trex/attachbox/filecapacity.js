Trex.install("attachbox.onFileCapacityInitialized @if sidebar.capacity.show = true",function(i,e,a,t,n){var u=i.getAttachBox();n.sidebar.capacity.show===_TRUE&&(Object.extend(u,Trex.I.FileCapacity),u.onFileCapacityInitialized(n,t))}),Trex.module("attachbox.updateCapacity on Trex.Ev.__ATTACHBOX_SHOW",function(i){var e=i.getAttachBox();e.observeJob(Trex.Ev.__ATTACHBOX_SHOW,function(){e.updateCapacity()})}),TrexConfig.addSidebar("capacity",{show:_TRUE,maximum:3145728,filemaximum:_NULL,filter:{use:"",sound:{title:"sound file",maximum:3145728,extensions:",mp3,wav,ogg,wma,mp4,ape,wmv,asf,ra,ram,"},movie:{title:"movie file",maximum:3145728,extensions:",wmv,mpg,avi,"}}}),Trex.I.FileCapacity={onFileCapacityInitialized:function(i,e){var a=(i.initializedId?i.initializedId:"",i.sidebar.capacity);a.uploaded=0,a.available=a.maximum,a.uploadedFileNum=0;var t=function(i,e){return e=parseInt(e,10),isNaN(e)||a[i]==_UNDEFINED?_FALSE:(a.group&&"available"==i?a[i]=Math.min(e,a.maximum,a.group.maximum-a.group.used):a[i]=e,a[i])};this.checkAvailableCapacity=function(){return a.uploaded<a.available},this.checkInsertableSize=function(i){return parseInt(a.uploaded,10)+parseInt(i,10)<=parseInt(a.available,10)},this.getCapacity=function(i){return a[i]||0},this.changeAvailableCapacity=function(i){return t("available",i)?(s(),i):_FALSE},this.changeMaximumCapacity=function(i){return t("maximum",i)?i:_FALSE},this.changeFileMaximumCapacity=function(i){return t("filemaximum",i)?i:_FALSE},this.updateCapacity=function(){s()};var n=function(i){var e=a.uploaded+i.toNumber();e<0&&(e=0),a.uploaded=e},u=function(i){n(-1*i),a.uploadedFileNum-=1},o=function(i){n(i),a.uploadedFileNum+=1},r={};a.filter.use.length>0&&a.filter.use.split(",").each(function(i){a.filter[i]&&(r[i]=Object.extend({},a.filter[i]))}),this.getFiltersNameByExt=function(i){var e=[];for(var a in r)r[a].extensions.indexOf(","+i.toLowerCase()+",")>-1&&e.push(a);return e},this.getFilterExtensions=function(i){return r[i]?r[i].extensions:_NULL},this.getFilterMaximum=function(i){return r[i]?r[i].maximum:_NULL},this.getUploadedSizeByFilter=function(i){var e=0,a=r[i].extensions;return this.datalist.each(function(i){if(i.data&&i.data.filename){var t=i.data.filename.split(".").pop().toLowerCase();a.indexOf(","+t+",")>-1&&(e+=i.data.filesize)}}),e},a.group&&t("available",Math.min(a.maximum,a.group.maximum-a.group.used)),this.getGroupCapacity=function(i){return a.group?a.group[i]||0:0},this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_ADDED,function(i){i.actor.isCheckSize&&(o(i.data.filesize||0),s())}),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_REMOVED,function(i){i.actor.isCheckSize&&(u(i.data.filesize||0),s())}),this.observeJob(Trex.Ev.__ENTRYBOX_ALL_ENTRY_REMOVED,function(){a.uploaded=0,a.uploadedFileNum=0,s()}),this.observeJob(Trex.Ev.__ENTRYBOX_ENTRY_REFRESH,function(i){if(i.actor.isCheckSize){var e=i.data.filesize||0;i.deletedMark?u(e):o(e),s()}});var l=this,s=function(){var i={uploaded:a.uploaded,available:a.available,maximum:a.maximum,uploadedFileNum:a.uploadedFileNum,group:a.group};l.fireJobs(Trex.Ev.__ENTRYBOX_CAPACITY_UPDATE,i)}}};